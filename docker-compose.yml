version: '3'

services:

  portainer:
    image: portainer/portainer:1.23.0
    environment:
      - HOST
    container_name: portainer
    command: -H unix:///var/run/docker.sock
    restart: always
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data
    ports:
      - 9000:9000
    labels:
      - traefik.frontend.rule=Host:portainer.${HOST}
      - traefik.port=9000
    networks:
      - proxy

  traefik:
    image: traefik:1.7.18
    container_name: traefik
    environment:
      - HOST
    command: --docker --docker.domain=docker.${HOST}
    ports:
      - 80:80
      - 443:443
    networks:
      - proxy
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./traefik_${HOST}.toml:/traefik.toml
      - ./acme.json:/acme.json
    labels:
      - traefik.frontend.rule=Host:traefik.${HOST}
      - traefik.port=8080
    restart: always

  mongodb:
    image: mongo:4.2.1
    container_name: mongodb
    restart: always
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD}
      MONGO_DATA_DB: ${MONGO_DATA_DB}
      MONGO_DATA_CONFIGDB: ${MONGO_DATA_CONFIGDB}
    volumes:
      - ${MONGO_DATA_DB}:/data/db
      - ${MONGO_DATA_CONFIGDB}:/data/configdb
    networks:
      - proxy
    ports:
      - 27017:27017
    labels:
      - traefik.enable=false

  #loris:
  #  image: bdlss/loris-openjpeg-docker:latest
  #  container_name: iiif-loris
  #  restart: unless-stopped
  #  environment:
  #    - HOST
  #    - IMAGE_LOCATION=/usr/local/share/images
  #  networks:
  #    - proxy
  #  volumes:
  #    - ${IMAGE_LOCATION}:/usr/local/share/images
  #  labels:
  #    - traefik.frontend.rule=Host:iiif.${HOST}
  #    - traefik.port=5004

  gendercomics-api:
    image: gendercomics/api:latest
    container_name: gendercomics-api
    environment:
      - HOST
      - SPRING_PROFILES_ACTIVE=stage
    networks:
      - proxy
    depends_on:
      - mongodb
    labels:
      - traefik.frontend.rule=Host:api.${HOST}
      - traefik.port=8001

volumes:
  portainer_data:

networks:
  proxy:
    external: true
#  keycloak:
#    external: false